<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>裁剪图片</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<!--标准mui.css-->
		<link rel="stylesheet" href="css/mui.min.css">
		<!--App自定义的css-->
		<link rel="stylesheet" type="text/css" href="css/app.css" />
		<link href="js/Jcrop/jquery.Jcrop.css" rel="stylesheet" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<button id="btnSelect" class="mui-btn mui-btn-success mui-pull-left">选择</button>
			<h1 id="title" class="mui-title">图片裁剪</h1>
			<button id="btngo" class="mui-btn mui-btn-success mui-pull-right">完成</button>
		</header>
		<div class="mui-content" id="imgcontent">
			<!--<img id="img" src="" width="100%">-->
		</div>

		<script type="text/javascript" src="js/jquery.js"></script>
		<script src="js/mui.min.js"></script>
		<script type="text/javascript" src="js/Jcrop/jquery.Jcrop.js"></script>
		<script type="text/javascript" charset="utf-8">
			mui.init({});
			mui.plusReady(function() {
				var url = location.href;
				url = url.substr(url.indexOf('=') + 1);
				$('#img').attr('src', url).load(function() {
					Clip.touchX = $('#img').width(); //当前的手指所处的X坐标
					Clip.touchY = $('#img').height(); //当前手指的Y坐标		         
				});
			});
			document.getElementById('btnSelect').addEventListener('tap', function() {
				var btnArray = [{
					title: '拍照'
				}, {
					title: '从相册选择'
				}];
				plus.nativeUI.actionSheet({
					title: "title",
					cancel: '取消',
					buttons: btnArray
				}, function(e) {
					var index = e.index; // 
					switch(index) {
						case 1:
							//拍照
							captureImage();

							function captureImage() {
								var cmr = plus.camera.getCamera();
								var res = cmr.supportedImageResolutions[0];
								var fmt = cmr.supportedImageFormats[0];
								cmr.captureImage(function(path) {
										plus.io.resolveLocalFileSystemURL(path, function(entry) {
											console.log("真实路径：" + entry.fullPath);
											var arr = new Array([entry.fullPath]);
											toNewWeiBo(arr);
										}, function(e) {
											alert(e.message);
										});
									},
									function(error) {
										alert("Capture image failed: " + error.message);
									}, {
										resolution: res,
										format: fmt
									}
								);
							}
							break;
						case 2:
							//从相册选择图片
							plus.gallery.pick(function(e) {
								for(var i in e.files) {
									console.log(e.files[i]);
								}
								plus.io.resolveLocalFileSystemURL(e.files[0], function(entry) {
									console.log("真实路径：" + entry.fullPath);
									var arr = new Array([entry.fullPath]);
									toNewWeiBo(arr);
								}, function(e) {
									alert(e.message);
								});
							}, function(e) {
								console.log("取消选择图片");
							}, {
								filter: "image",
								multiple: true
							});
							break;
					}
				});

			});

			function toNewWeiBo(patharr) {
				//				mui.openWindow({
				//							url: "imageCut.html",
				//							id: "imageCut",
				//							createNew: true,
				//							extras: {
				//								path: patharr //扩展参数
				//							},
				//							show: {
				//								aniShow: 'slide-in-right',
				//								duration: 200
				//							}
				//						});

				//----------------
				
				mui.openWindow({
					url: "logocut.html",
					id: "logocut",
					createNew: true,
					extras: {
						path: patharr //扩展参数
					},
					show: {
						aniShow: 'slide-in-right',
						duration: 200
					}
				});
			}

			$("#btngo").click(function() {
				//获取width和height的百分比
				var widthPix = (Clip.size / $('#img').width()).toFixed(2) * 100;
				var heightPix = (Clip.size / $('#img').height()).toFixed(2) * 100;
				//获取左上角位置百分比
				var topPix = ((Clip.topCss - 50) / $('#img').height()).toFixed(2) * 100;
				var leftPix = (Clip.leftCss / $('#img').width()).toFixed(2) * 100;

				//对图片进行裁剪
				plus.zip.compressImage({
						src: $('#img').attr('src'), //search.src, //src在这里是第一步Url里的src。也就是本地路径
						dst: '_doc/a.jpg',
						overwrite: true,
						clip: {
							top: topPix + '%',
							left: leftPix + '%',
							width: widthPix + '%',
							height: heightPix + '%'
						}
					},
					function(e) {
						//$('#tmpa').attr('src',e.target)
						// resizeImage(e.target); //压缩图片

					}
				);
			});

			var Clip = {
				size: 200, //这个表示正方形目前的边长，乘上一个基数就是当前的像素值
				range: {}, //用来控制正方形left和top的极限值，以免移出边界
				topCss: 60, //表示当前的top值
				leftCss: 60, //表示当前的left值
				touchX: 500, //当前的手指所处的X坐标
				touchY: 1000, //当前手指的Y坐标
				timer: null
			}

			//---------------------------
			function initJcrop() {
				console.log(document.body.clientWidth);
				$('#imgcontent').Jcrop({
					onSelect: updateCoords,
					allowMove: true,
					aspectRatio: 1,
					boxWidth: 600,
					boxHeight: 300
				}, function() {

					//图片实际尺寸  
					var bb = this.getBounds();
					var bWidth = Number(bb[0]) / 2;
					var bHeight = Number(bb[1]) / 2;

					this.setSelect([0, 0, bWidth, bHeight]);

					var ss = this.getWidgetSize();
					var aheight = (300 - Number(ss[1])) / 2 + "px";
					$(".jcrop-holder").css("margin-top", aheight);

				});
			}

			function updateCoords(c) {
				//      console.log(c);  
				//var img = document.getElementById("cropbox");
				//var ctx = document.getElementById("myCan").getContext("2d");

				//img,开始剪切的x,Y坐标宽高，放置图像的x,y坐标宽高。  
				//ctx.drawImage(img, c.x, c.y, c.w, c.h, 0, 0, 200, 200);
			}

			function subform() {

				if($("#imgfield").html()) {
					//获取裁剪完后的base64图片url,转换为blob  
					var data = document.getElementById("myCan").toDataURL();
					var formData = new FormData();
					formData.append("imageName", dataURLtoBlob(data));

					var httprequest = new XMLHttpRequest();
					var apiurl = ""; //上传图片的api接口，自行填写  
					httprequest.open('POST', apiurl, true);
					httprequest.send(formData);
					httprequest.onreadystatechange = function() {
						if(httprequest.status == 200 && httprequest.readyState == 4) {

							var json = JSON.parse(httprequest.responseText);
							console.log(json)
						} else {
							alert("上传图片失败！api错误")
						}
					};

				} else {

					alert("请选择图片!")
				}

			}
		</script>
	</body>

</html>