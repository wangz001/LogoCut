<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<link href="js/Jcrop/jquery.Jcrop.css" rel="stylesheet" />

	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 id="title" class="mui-title">裁剪</h1>
			<a id="btngo" class="mui-icon mui-icon-plus mui-pull-right" style="color: #999;"></a>
		</header>
		<div class="mui-content">
			<div class="uploadPics">
				<div class="picCont" style="width:100%;height:80%;margin:20px auto 0;padding:0;">
					<div id=imgfield style=overflow:hidden;width:100%;height:100%></div>
				</div>
				
			</div>

			<canvas id="myCan" width="200" height="200"></canvas>

		</div>

		<nav class="mui-bar mui-bar-tab">
			<a id="btnplus" class="mui-tab-item">
				<span class="mui-icon mui-icon-plus"></span>
				<span class="mui-tab-label">选图</span>
			</a>
			<a id="clipBtn" class="mui-tab-item">
				<span class="mui-icon mui-icon-minus"></span>
				<span class="mui-tab-label">裁剪</span>
			</a>
		</nav>
		<script src="js/mui.min.js"></script>
		<script type="text/javascript" src="js/photoClip/jquery-2.1.3.min.js"></script>
		<script type="text/javascript" src="js/Jcrop/jquery.Jcrop.js"></script>
		<script type="text/javascript">
			mui.init();

			mui.plusReady(function() {
				//获取参数
				var self = plus.webview.currentWebview();
				var path = self.path;
				if(path != undefined) {
					document.getElementById('sourceimg').setAttribute('src', path);
				}
			});

			//处理右上角关于图标的点击事件；
			document.getElementById('btnplus').addEventListener('tap', function() {

				var btnArray = [{
					title: '拍照'
				}, {
					title: '从相册选择'
				}];
				plus.nativeUI.actionSheet({
					title: "title",
					cancel: '取消',
					buttons: btnArray
				}, function(e) {
					var index = e.index; // 
					switch(index) {
						case 1:
							//拍照
							captureImage();

							function captureImage() {
								var cmr = plus.camera.getCamera();
								var res = cmr.supportedImageResolutions[0];
								var fmt = cmr.supportedImageFormats[0];
								cmr.captureImage(function(path) {
										plus.io.resolveLocalFileSystemURL(path, function(entry) {
											console.log("真实路径：" + entry.fullPath);
											var arr = new Array([entry.fullPath]);
											toNewWeiBo(arr);
										}, function(e) {
											alert(e.message);
										});
									},
									function(error) {
										alert("Capture image failed: " + error.message);
									}, {
										resolution: res,
										format: fmt
									}
								);
							}
							break;
						case 2:
							//从相册选择图片
							plus.gallery.pick(function(e) {
								for(var i in e.files) {
									console.log(e.files[i]);
								}
								plus.io.resolveLocalFileSystemURL(e.files[0], function(entry) {
									console.log("真实路径：" + entry.fullPath);
									var arr = new Array([entry.fullPath]);
									toNewWeiBo(arr);
								}, function(e) {
									alert(e.message);
								});
							}, function(e) {
								console.log("取消选择图片");
							}, {
								filter: "image",
								multiple: true
							});
							break;
					}
				});
			});

			document.getElementById('clipBtn').addEventListener('tap', function() {
				subform();
			});

			function toNewWeiBo(patharr) {
				var localimghtml = '<img id="cropbox" src="' + patharr + '" >';
				$("#imgfield").html(localimghtml);
				initJcrop();
			}

			function initJcrop() {
				$('#cropbox').Jcrop({
					onSelect: updateCoords,
					allowMove: true,
					aspectRatio: 1,
					boxWidth: 300,
					boxHeight: 300
				}, function() {

					//图片实际尺寸  
					var bb = this.getBounds();
					var bWidth = Number(bb[0]) / 2;
					var bHeight = Number(bb[1]) / 2;

					this.setSelect([0, 0, bWidth, bHeight]);

					var ss = this.getWidgetSize();
					var aheight = (300 - Number(ss[1])) / 2 + "px";
					$(".jcrop-holder").css("margin-top", aheight);

				});
			}

			function updateCoords(c) {
				//      console.log(c);  
				var img = document.getElementById("cropbox");
				var ctx = document.getElementById("myCan").getContext("2d");

				//img,开始剪切的x,Y坐标宽高，放置图像的x,y坐标宽高。  
				ctx.drawImage(img, c.x, c.y, c.w, c.h, 0, 0, 200, 200);
			}

			function subform() {

				if($("#imgfield").html()) {
					//获取裁剪完后的base64图片url,转换为blob  
					var data = document.getElementById("myCan").toDataURL();
					var formData = new FormData();
					formData.append("imageName", dataURLtoBlob(data));

					var httprequest = new XMLHttpRequest();
					var apiurl = ""; //上传图片的api接口，自行填写  
					httprequest.open('POST', apiurl, true);
					httprequest.send(formData);
					httprequest.onreadystatechange = function() {
						if(httprequest.status == 200 && httprequest.readyState == 4) {

							var json = JSON.parse(httprequest.responseText);
							console.log(json)
						} else {
							alert("上传图片失败！api错误")
						}
					};

				} else {

					alert("请选择图片!")
				}

			}
		</script>

	</body>

</html>